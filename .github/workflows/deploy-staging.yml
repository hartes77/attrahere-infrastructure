name: ðŸš€ Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'The Git SHA tag of the Docker image to deploy'
        required: true
        type: string

env:
  AWS_REGION: eu-central-1
  TF_VERSION: "1.5.0"
  WORKING_DIRECTORY: environments/staging

# OIDC permissions for AWS authentication
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: ðŸš€ Deploy Infrastructure to Staging
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: GitHub-Actions-Deploy-Infrastructure
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ðŸ—ï¸ Terraform Init
        run: terraform init
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: ðŸ“‹ Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var="image_tag=${{ github.event.inputs.image_tag }}" \
            -var="vpc_name=attrahere-staging-vpc" \
            -var="vpc_cidr=10.0.0.0/16" \
            -var='vpc_azs=["eu-central-1a", "eu-central-1b"]' \
            -var='vpc_private_subnets=["10.0.1.0/24", "10.0.2.0/24"]' \
            -var='vpc_public_subnets=["10.0.101.0/24", "10.0.102.0/24"]' \
            -var="api_secret_key_arn=${{ secrets.API_SECRET_KEY_ARN }}" \
            -var="jwt_secret_arn=${{ secrets.JWT_SECRET_ARN }}" \
            -out=tfplan
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: ðŸš€ Terraform Apply
        run: |
          terraform apply \
            -auto-approve \
            tfplan
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Version**: ${{ env.TF_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Working Directory**: ${{ env.WORKING_DIRECTORY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Resources Updated" >> $GITHUB_STEP_SUMMARY
          echo "- ECS Service: attrahere-platform-service" >> $GITHUB_STEP_SUMMARY
          echo "- ECS Cluster: attrahere-staging" >> $GITHUB_STEP_SUMMARY
          echo "- Container Image: Updated to tag \`${{ github.event.inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY